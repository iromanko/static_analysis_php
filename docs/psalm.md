# Psalm – статический анализатор кода для PHP

## 1. Что такое Psalm?
Psalm – это мощный статический анализатор кода для PHP, разработанный для обнаружения ошибок, потенциальных проблем и улучшения качества кода. Он позволяет находить типовые ошибки, анализировать потоки данных и проверять строгую типизацию.

## 2. Для чего нужен Psalm?
Psalm помогает:
- Обнаруживать ошибки типов до выполнения кода.
- Улучшать поддержку строгой типизации.
- Оптимизировать код за счёт анализа потока выполнения.
- Поддерживать код в чистом и читаемом виде.

## 3. Установка и настройка
Psalm устанавливается через Composer:
```bash
composer require --dev vimeo/psalm
```
После установки инициализируем конфигурацию:
```bash
vendor/bin/psalm --init
```
Этот шаг создаст файл `psalm.xml`, содержащий основные настройки анализатора.

## 4. Использование в PhpStorm
### 4.1. Настройка Psalm в PhpStorm
1. Открыть **Preferences** (*⌘ + ,* на macOS, *Ctrl + Alt + S* на Windows/Linux).
2. Перейти в **Languages & Frameworks → PHP → Quality Tools**.
3. В разделе **Psalm** указать путь к бинарному файлу (`vendor/bin/psalm`).
4. Указать путь к конфигурационному файлу (`psalm.xml`).
5. Нажать **Apply** и **OK**.

### 4.2. Проверка кода в PhpStorm
1. Открыть файл PHP.
2. Запустить **Code Inspections**.
3. Проблемные участки кода будут подсвечены в редакторе.

## 5. Использование в GitHub Actions
Psalm можно запускать в CI/CD для автоматического анализа кода.

### 5.1. Пример конфигурации GitHub Actions
Создадим файл `.github/workflows/psalm.yml`:
```yaml
name: Psalm

on: [push, pull_request]

jobs:
  psalm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer
      
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress
      
      - name: Run Psalm
        run: vendor/bin/psalm
```
Этот workflow автоматически проверяет код при каждом коммите или Pull Request.

## 6. Error Level
Psalm позволяет настраивать уровень строгости проверки кода через `errorLevel`. Чем выше уровень, тем меньше ошибок будет пропускаться:
```xml
<psalm errorLevel="2">
    <projectFiles>
        <directory name="src"/>
    </projectFiles>
</psalm>
```
- `1` – самый строгий уровень (рекомендуется для новых проектов).
- `8` – наименее строгий уровень (подходит для старых проектов).

## 7. Baseline
Если проект уже содержит много ошибок, можно использовать **baseline**, чтобы зафиксировать текущее состояние и постепенно исправлять проблемы.

### 7.1. Создание baseline
```bash
vendor/bin/psalm --set-baseline=psalm-baseline.xml
```
После этого текущие ошибки будут зафиксированы в `psalm-baseline.xml`, и новые ошибки будут проверяться отдельно.

### 7.2. Использование baseline
Psalm автоматически использует baseline, если он указан в `psalm.xml`:
```xml
<psalm>
    <baselines>
        <baseline file="psalm-baseline.xml" />
    </baselines>
</psalm>
```
Этот механизм позволяет внедрять Psalm в существующий код без необходимости исправлять все ошибки сразу.

## 8. Альтернатива: PHPStan

Если Psalm кажется слишком строгим или сложным, можно использовать PHPStan – ещё один статический анализатор с аналогичным функционалом. 
Он устанавливается через Composer:

```bash
composer require --dev phpstan/phpstan
```

Пример запуска анализа:

```bash
vendor/bin/phpstan analyse --level=7 src/
```

Уровень анализа (`--level=7`) можно варьировать, где `0` – самый мягкий, а `9` – самый строгий.


## 9. Заключение
Psalm – мощный инструмент для анализа кода в PHP, позволяющий находить потенциальные ошибки и улучшать качество кода. 
Интеграция с IDE и CI/CD делает его удобным для повседневного использования.
Использование **error level** и **baseline** позволяет адаптировать анализатор под любой проект, минимизируя риски и улучшая процесс разработки. 
В качестве альтернативы можно использовать PHPStan, если требуется менее строгий анализ.
